var Tree=function(){var t=.618,i=Math.PI/180;function e(t){return t.min+(t.max-t.min)*Math.random()}function n(t,i){return null==t?i:t}var o=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){setTimeout(t,1/60*1e3)},r=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(t){clearTimeout(t)};function s(t,i,e,n,o){this.from=this.current=t,this.to=i,this.duration=e,this.currentFrame=0,this.delay=n,this.onUpdate=o}function h(t,i){this.context=t.getContext("2d"),this.flowers=[],this.tweens=[],this.currentFrame=0,this.animId=void 0,(i=n(i,{})).flower=n(i.flower,{}),this.options={startX:n(i.startX,.5*t.width),startY:n(i.startY,t.height),startAngle:n(i.startAngle,90),strokeStyle:n(i.strokeColor,"#000"),widthPerLevel:n(i.widthPerLevel,1),lengthPerLevel:n(i.lengthPerLevel,30),level:n(i.level,8),angle:n(i.angle,{min:30,max:60}),framePerPx:n(i.framePerPx,.1),flower:{width:n(i.flower.width,{min:4,max:12}),image:i.flower.image}}}return s.prototype={on:function(){var t={};Object.keys(this.from).forEach(function(i){t[i]=this.from[i]+this.currentFrame/this.duration*(this.to[i]-this.from[i])}.bind(this)),this.onUpdate&&this.onUpdate(t,this.current),this.current=t,this.currentFrame+=1}},h.prototype={update:function(){var t=!1;this.tweens.forEach(function(i){i.delay<=this.currentFrame&&i.currentFrame<=i.duration&&(t=!0,i.on())}.bind(this)),!1===t?(r(this.animId),this.bloom()):(this.currentFrame+=1,animId=o(this.update.bind(this)))},grow:function(){return this.drawTrunkAndBranch(this.options.startX,this.options.startY,this.options.startAngle,1,0),this.animId=o(this.update.bind(this)),this},drawTrunkAndBranch:function(t,n,o,r,h){if(r<=this.options.level){var a=this.getValue(r,this.options.lengthPerLevel),l=o*i,m=t+a*Math.cos(l),u=n-a*Math.sin(l),d=Math.round(a*this.options.framePerPx);this.tweens.push(new s({x:t,y:n},{x:m,y:u},d,h,function(t,i){this.context.beginPath(),this.context.strokeStyle=this.options.strokeStyle,this.context.lineWidth=this.getValue(r,this.options.widthPerLevel),this.context.moveTo(i.x,i.y),this.context.lineTo(t.x,t.y),this.context.stroke()}.bind(this))),this.drawTrunkAndBranch(m,u,o+.5*e(this.options.angle),r+1,h+d),this.drawTrunkAndBranch(m,u,o-.5*e(this.options.angle),r+1,h+d),this.getFlowerPosition(t,n,m,u)}},getValue:function(i,e){return Math.pow(t,i-1)*this.options.level*e},getFlowerPosition:function(i,e,n,o){var r=Math.random(),s={};r<1/3?(s.x=(n-i)*(1-t)+i,s.y=(o-e)*(1-t)+e):r<2/3?(s.x=(n-i)*t+i,s.y=(o-e)*t+e):(s.x=n,s.y=o),this.flowers.push(s)},bloom:function(){this.options.flower.image;this.flowers.forEach(function(t){new function(t,i,n,o){var r=e(o.width),s=o.image.width/o.image.height*r;t.globalAlpha=Math.random(),t.drawImage(o.image,0,0,o.image.width,o.image.height,i-.5*r,n-.5*s,r,s),t.globalAlpha=1}(this.context,t.x,t.y,this.options.flower)}.bind(this))}},h}();